# Plan: Fix Laggy Animation - 60fps Time Updates

## Root Cause

The HTML Audio `timeupdate` event fires only **~4 times per second** (~250ms intervals), not 60fps. The shimmer updates at 4fps, causing the laggy/robotic feel.

## Solution

Use `requestAnimationFrame` to poll `audio.currentTime` at 60fps when playing.

## File to Modify

| File | Changes |
|------|---------|
| `src/hooks/useAudioPlayer.ts` | Use rAF loop instead of timeupdate event |

## Detailed Changes

### `src/hooks/useAudioPlayer.ts`

Replace the `timeupdate` event listener with a `requestAnimationFrame` loop that runs while playing:

```tsx
// Add rAF-based time tracking
useEffect(() => {
  if (!isPlaying || !audioRef.current) return;

  let rafId: number;
  const updateTime = () => {
    if (audioRef.current) {
      setCurrentTime(audioRef.current.currentTime);
    }
    rafId = requestAnimationFrame(updateTime);
  };
  
  rafId = requestAnimationFrame(updateTime);
  
  return () => cancelAnimationFrame(rafId);
}, [isPlaying]);
```

And remove/simplify the `timeupdate` event listener (keep it as fallback for when paused).

## Full Implementation

```tsx
export function useAudioPlayer(src: string): AudioPlayerState & AudioPlayerControls {
  const audioRef = useRef<HTMLAudioElement | null>(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [currentTime, setCurrentTime] = useState(0);
  const [duration, setDuration] = useState(0);
  const [isLoaded, setIsLoaded] = useState(false);

  // Initialize audio element
  useEffect(() => {
    const audio = new Audio(src);
    audioRef.current = audio;

    const handleLoadedMetadata = () => {
      setDuration(audio.duration);
      setIsLoaded(true);
    };

    const handleEnded = () => {
      setIsPlaying(false);
      setCurrentTime(0);
    };

    const handlePlay = () => setIsPlaying(true);
    const handlePause = () => setIsPlaying(false);

    audio.addEventListener("loadedmetadata", handleLoadedMetadata);
    audio.addEventListener("ended", handleEnded);
    audio.addEventListener("play", handlePlay);
    audio.addEventListener("pause", handlePause);

    return () => {
      audio.removeEventListener("loadedmetadata", handleLoadedMetadata);
      audio.removeEventListener("ended", handleEnded);
      audio.removeEventListener("play", handlePlay);
      audio.removeEventListener("pause", handlePause);
      audio.pause();
      audioRef.current = null;
    };
  }, [src]);

  // 60fps time updates while playing
  useEffect(() => {
    if (!isPlaying || !audioRef.current) return;

    let rafId: number;
    const updateTime = () => {
      if (audioRef.current) {
        setCurrentTime(audioRef.current.currentTime);
      }
      rafId = requestAnimationFrame(updateTime);
    };

    rafId = requestAnimationFrame(updateTime);

    return () => cancelAnimationFrame(rafId);
  }, [isPlaying]);

  // ... rest of the hook (play, pause, toggle, seek)
}
```

## Why This Works

- `requestAnimationFrame` runs at ~60fps (every ~16ms)
- Shimmer progress updates 60 times per second instead of 4
- Combined with the soft gradient, animation will feel smooth and fluid

## Verification

1. Run `bun dev`
2. Play the audio and verify:
   - Shimmer sweep is smooth at 60fps
   - No visible stepping or lag
   - Animation feels fluid and natural
