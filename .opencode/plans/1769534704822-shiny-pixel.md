# Plan: Dynamic Suno Song Lyrics Visualizer

## Overview
Add a new route `/song/[songId]` that fetches any Suno song, transcribes it via ElevenLabs, caches the lyrics in Vercel Blob, and displays the synced lyrics visualization.

## Key Decisions
- **ElevenLabs API**: Use `cloud_storage_url` parameter to pass Suno CDN URL directly (no download needed)
- **Caching**: Store transcribed lyrics in Vercel Blob to avoid re-transcription
- **Loading**: Show loading screen while transcribing (synchronous, blocks in loader)
- **Share hash**: Ignore `sh` query param for now (just part of Suno URL format)

## Files to Create/Modify

### 1. New Dependencies
```bash
bun add @elevenlabs/elevenlabs-js @vercel/blob
```

### 2. Environment Variables
Create `.env.local`:
```
ELEVENLABS_API_KEY=sk_...
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_...
```

### 3. Server Functions - `src/server/lyrics.ts` (NEW)

Server-side logic for transcription and caching:

```typescript
import { createServerFn } from "@tanstack/react-start/server"
import { ElevenLabsClient } from "@elevenlabs/elevenlabs-js"
import { put, head } from "@vercel/blob"
```

**Functions to implement:**
- `getCachedLyrics(songId)` - Check if lyrics exist in Vercel Blob
- `transcribeSong(songId)` - Call ElevenLabs with Suno CDN URL, save to Blob
- `getSongLyrics(songId)` - Main function: check cache, transcribe if needed

**Blob storage path**: `songs/{songId}/lyrics.json`

**ElevenLabs API call**:
```typescript
const result = await client.speechToText.convert({
  model_id: "scribe_v1",
  cloud_storage_url: `https://cdn1.suno.ai/${songId}.m4a`,
  timestamps_granularity: "word",
  tag_audio_events: true,
})
```

### 4. Dynamic Route - `src/routes/song/$songId.tsx` (NEW)

```typescript
import { createFileRoute } from "@tanstack/react-router"

export const Route = createFileRoute("/song/$songId")({
  loader: async ({ params }) => {
    return await getSongLyrics({ data: { songId: params.songId } })
  },
  pendingComponent: ProcessingPage,
  errorComponent: ErrorPage,
  component: SongPlayer,
})
```

**SongPlayer component**:
- Get `songId` from params
- Audio URL: `https://cdn1.suno.ai/${songId}.m4a`
- Use existing `useAudioPlayer`, `LyricsDisplay`, `AudioControls`
- Same layout as `src/routes/index.tsx`

**ProcessingPage component**:
- Spinner animation
- "Transcribing lyrics..." message
- "This may take up to 30 seconds for new songs"

**ErrorPage component**:
- Handle "Song not found" (404 from Suno CDN)
- Handle transcription errors
- "Go back home" link

### 5. Existing Files (No Changes Needed)
- `src/lib/lyrics.ts` - LyricWord interface already matches ElevenLabs format
- `src/components/LyricsDisplay.tsx` - Already generic, works with any lyrics
- `src/components/AudioControls.tsx` - Already generic
- `src/hooks/useAudioPlayer.ts` - Already accepts any audio URL

## Data Flow

```
1. User visits /song/{songId}
2. Route loader calls getSongLyrics(songId)
3. Check Vercel Blob for cached lyrics
   ├─ CACHE HIT: Return cached JSON
   └─ CACHE MISS:
      a. Call ElevenLabs speechToText.convert({cloud_storage_url: cdn1.suno.ai/{id}.m4a})
      b. Save result to Vercel Blob
      c. Return lyrics
4. SongPlayer renders with:
   - Audio from cdn1.suno.ai/{songId}.m4a
   - Lyrics from loader data
   - Same visualization as homepage
```

## Cached Lyrics JSON Structure

```json
{
  "songId": "ce87faea-5af6-463d-bb2d-972f269a6b26",
  "transcribedAt": "2024-01-15T10:30:00Z",
  "languageCode": "eng",
  "languageProbability": 0.97,
  "text": "Full transcript...",
  "words": [
    { "text": "[singing]", "start": 0.22, "end": 22.38, "type": "audio_event" },
    { "text": " ", "start": 23.84, "end": 23.9, "type": "spacing" },
    { "text": "Too", "start": 23.9, "end": 24.2, "type": "word" }
  ]
}
```

## Implementation Order

1. Install dependencies (`@elevenlabs/elevenlabs-js`, `@vercel/blob`)
2. Set up environment variables
3. Create `src/server/lyrics.ts` with server functions
4. Create `src/routes/song/$songId.tsx` route
5. Test with a known Suno song ID

## Verification Steps

1. **Dev server**: `bun dev`
2. **Test with existing song**: Navigate to `/song/ce87faea-5af6-463d-bb2d-972f269a6b26`
3. **Verify transcription**: First load should show loading, then lyrics
4. **Verify caching**: Second load should be instant (from Blob)
5. **Verify error handling**: Test with invalid song ID
6. **Verify audio sync**: Play/pause, seek, word highlighting should work

---

## Enhancement: Song Metadata & Cover Image

### Goal
Display song title, artist name, and cover image by fetching metadata from Suno's page.

### Suno URL Patterns

| Asset | URL Pattern |
|-------|-------------|
| Page | `https://suno.com/song/{songId}` |
| Image | `https://cdn2.suno.ai/image_{songId}.jpeg` |
| Large Image | `https://cdn2.suno.ai/image_large_{songId}.jpeg` |
| Audio MP3 | `https://cdn1.suno.ai/{songId}.mp3` |
| Audio M4A | `https://cdn1.suno.ai/{songId}.m4a` |

### Metadata to Extract (from HTML meta tags)

```html
<meta property="og:title" content="Til it isn't"/>
<meta name="description" content="Til it isn't by rassmussen2000 (@rassmussen2000)..."/>
<meta property="og:image" content="https://cdn2.suno.ai/image_large_{songId}.jpeg"/>
```

### Implementation

#### 1. Update `src/server/lyrics.ts`

Add function to fetch song metadata:

```typescript
export interface SongMetadata {
  title: string
  artist: string
  imageUrl: string
}

export const getSongMetadata = createServerFn({ method: "GET" })
  .inputValidator((data: { songId: string }) => data)
  .handler(async ({ data }) => {
    const { songId } = data
    const pageUrl = `https://suno.com/song/${songId}`
    
    const response = await fetch(pageUrl)
    const html = await response.text()
    
    // Parse meta tags
    const titleMatch = html.match(/<meta property="og:title" content="([^"]+)"/)
    const descMatch = html.match(/<meta name="description" content="([^"]+)"/)
    
    const title = titleMatch?.[1] ?? "Unknown Song"
    
    // Extract artist from description: "Song Title by ArtistName (@handle)"
    const artistMatch = descMatch?.[1]?.match(/by ([^(]+)/)
    const artist = artistMatch?.[1]?.trim() ?? "Unknown Artist"
    
    // Image URL pattern
    const imageUrl = `https://cdn2.suno.ai/image_${songId}.jpeg`
    
    return { title, artist, imageUrl }
  })
```

#### 2. Update loader in `src/routes/song/$songId.tsx`

Fetch both lyrics and metadata in parallel:

```typescript
loader: async ({ params }) => {
  const [lyrics, metadata] = await Promise.all([
    getSongLyrics({ data: { songId: params.songId } }),
    getSongMetadata({ data: { songId: params.songId } }),
  ])
  return { lyrics, metadata }
}
```

#### 3. Update UI in `SongPlayer` component

Display cover image and song info:

```tsx
function SongPlayer() {
  const { songId } = Route.useParams()
  const { lyrics, metadata } = Route.useLoaderData()
  
  // ... existing code ...
  
  return (
    <div>
      {/* Header with cover image */}
      <div className="fixed top-0 ...">
        <img 
          src={metadata.imageUrl} 
          alt={metadata.title}
          className="w-16 h-16 rounded-lg object-cover"
        />
        <div>
          <h1>Now Playing</h1>
          <h2>{metadata.title}</h2>
          <p>{metadata.artist}</p>
        </div>
      </div>
      
      {/* Rest of the UI */}
    </div>
  )
}
```

### Files to Modify

| File | Changes |
|------|---------|
| `src/server/lyrics.ts` | Add `getSongMetadata` server function |
| `src/routes/song/$songId.tsx` | Update loader to fetch metadata, update UI with image/title/artist |

### Verification

1. Visit `/song/ce87faea-5af6-463d-bb2d-972f269a6b26`
2. Should see:
   - Cover image from Suno CDN
   - Title: "Til it isn't"
   - Artist: "rassmussen2000"

## Notes

- ElevenLabs file size limit: 2GB for URLs (Suno songs are typically <10MB)
- Transcription typically takes 10-30 seconds for a 3-minute song
- Vercel Blob caches indefinitely (lyrics don't change)
- M4A format is supported by ElevenLabs and `<audio>` element

---

## Issues Found During Testing

### 1. ElevenLabs Free Tier Blocked
**Status**: Requires paid subscription

The ElevenLabs API returns 401 with "detected_unusual_activity" for free tier accounts. Solutions:
- Purchase ElevenLabs paid subscription
- Try without VPN/proxy

### 2. Improve Error Handling
**Status**: Enhancement needed

The ErrorPage should better handle specific API errors:
- ElevenLabs 401 errors (subscription required)
- Rate limiting errors
- Network errors

### 3. Root Route notFoundComponent Warning
**Status**: Optional fix

The warnings about "notFoundError on route __root__" are not blocking. To suppress:
- Add `notFoundComponent` to `src/routes/__root.tsx`

## Fixes to Apply

### Fix 1: Better error messages in ErrorPage

Update `src/routes/song/$songId.tsx` ErrorPage to detect ElevenLabs API errors:

```typescript
function ErrorPage({ error }: { error: Error }) {
	const isSongNotFound = error.message.includes("not found")
	const isApiError = error.message.includes("detected_unusual_activity") || 
	                   error.message.includes("401")

	return (
		// ... existing JSX with updated error messages
		<h1>{isApiError ? "API Error" : isSongNotFound ? "Song Not Found" : "Something went wrong"}</h1>
		<p>{isApiError 
			? "The transcription service requires a paid subscription. Please check your ElevenLabs API key."
			: isSongNotFound 
			? "The song you're looking for doesn't exist."
			: error.message}</p>
	)
}
```
